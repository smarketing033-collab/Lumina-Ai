<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lumina â€” Forex Partner (All-in-One)</title>

<!-- Lightweight Charts -->
<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

<style>
/* ---------- Theme & base ---------- */
:root{
  --bg-dark:#071022; --panel:#071733; --muted:#9fb7ca; --accent:#2ee28b; --danger:#ff5c6c;
  --glass: rgba(255,255,255,0.03); --glass-2: rgba(0,0,0,0.04);
  --light-bg:#f5f8fb; --light-text:#0b1220; --card-light:#ffffff;
}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,Helvetica,sans-serif;background:var(--bg-dark);color:#e6eef8;-webkit-font-smoothing:antialiased}
body.light{background:var(--light-bg);color:var(--light-text)}
.app{display:grid;grid-template-columns:1fr 420px;gap:12px;height:100vh;padding:12px;box-sizing:border-box}
@media(max-width:1000px){ .app{grid-template-columns:1fr;padding:8px} .assistantBtn{right:12px;bottom:12px} .desktopToggle{left:8px} .app{grid-template-columns:1fr} }

/* ---------- Card ---------- */
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
body.light .card{background:var(--card-light);color:var(--light-text);box-shadow:0 6px 20px rgba(0,0,0,0.06)}

/* ---------- Controls ---------- */
select,input,button{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:14px}
body.light select,input,button{border:1px solid #e6eef8}
#chartContainer{height:72vh;border-radius:10px;overflow:hidden}
.small{font-size:13px;color:var(--muted)}

/* ---------- Signals ---------- */
.signalsList{max-height:340px;overflow:auto;margin-top:8px}
.signalItem{padding:10px;border-bottom:1px dashed rgba(255,255,255,0.03)}
.tagBuy{color:var(--accent);font-weight:800}
.tagSell{color:var(--danger);font-weight:800}

/* ---------- Toast ---------- */
.toast{position:fixed;right:20px;bottom:20px;background:#142233;padding:10px 14px;border-radius:10px;display:none;color:white;z-index:200}
body.light .toast{background:#222;color:white}

/* ---------- Assistant ---------- */
.assistantBtn{position:fixed;right:18px;bottom:18px;background:linear-gradient(90deg,#6f21d1,#d13fb8);border-radius:999px;padding:14px 18px;color:white;font-weight:700;box-shadow:0 12px 40px rgba(100,40,160,0.28);z-index:220;border:none}
.desktopToggle{position:fixed;left:18px;bottom:18px;padding:8px;border-radius:8px;background:#0b2540;color:#fff;z-index:220}
.assistantPanel{position:fixed;left:0;right:0;bottom:0;height:0;max-height:92vh;background:var(--panel);border-top-left-radius:14px;border-top-right-radius:14px;overflow:hidden;transition:height .28s;z-index:230}
body.light .assistantPanel{background:#fff;color:var(--light-text)}
.assistantHeader{display:flex;align-items:center;gap:12px;padding:12px;border-bottom:1px solid rgba(255,255,255,0.03)}
.avatar{width:56px;height:56px;border-radius:12px;flex-shrink:0;background:linear-gradient(135deg,#ffe6f6,#ffd8b0);display:flex;align-items:center;justify-content:center;color:#111;font-weight:800}
.assistantBody{display:flex;flex-direction:column;height:calc(92vh - 140px)}
.chatArea{flex:1;overflow:auto;padding:12px}
.chatInput{display:flex;gap:8px;padding:8px;border-top:1px solid rgba(255,255,255,0.02)}
.chatBubble{max-width:78%;padding:12px;border-radius:14px;margin-bottom:8px}
.bubbleUser{background:#0f1724;color:#fff;margin-left:auto;border-bottom-right-radius:4px}
.bubbleLumina{background:#0b3140;color:#fff;border-bottom-left-radius:4px}
body.light .bubbleUser{background:#e6eef8;color:var(--light-text)}
body.light .bubbleLumina{background:#eef7fb;color:var(--light-text)}

/* ---------- Desktop mode ---------- */
body.desktop .app{grid-template-columns:1fr 520px}
body.desktop #chartContainer{height:82vh}

/* ---------- Utility ---------- */
.hidden{display:none}
.copyBtn, .sendBtn {padding:8px 10px;border-radius:8px;border:none;background:#1f2937;color:white}
.sendBtn {background:#2563eb}
.badge{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.03);font-weight:700}
</style>
</head>
<body>

<div class="app">
  <!-- LEFT: Chart -->
  <div class="card">
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap">
      <select id="symbolSelect" title="Symbol" style="min-width:160px;max-width:45%"></select>
      <select id="tfSelect" title="Timeframe" style="min-width:120px">
        <!-- All timeframes 1s -> 1Y -->
        <optgroup label="Ultra (seconds)">
          <option value="1s">1s</option><option value="5s">5s</option><option value="10s">10s</option><option value="15s">15s</option><option value="30s">30s</option>
        </optgroup>
        <optgroup label="Minutes">
          <option value="1min">1m</option><option value="3min">3m</option><option value="5min">5m</option><option value="10min">10m</option><option value="15min">15m</option><option value="30min">30m</option>
        </optgroup>
        <optgroup label="Hours">
          <option value="45min">45m</option><option value="1h">1h</option><option value="2h">2h</option><option value="3h">3h</option><option value="4h">4h</option><option value="6h">6h</option><option value="8h">8h</option><option value="12h">12h</option>
        </optgroup>
        <optgroup label="Days / Weeks / Months">
          <option value="1day">1D</option><option value="2day">2D</option><option value="3day">3D</option><option value="1w">1W</option><option value="2w">2W</option>
          <option value="1M">1M</option><option value="3M">3M</option><option value="6M">6M</option><option value="1Y">1Y</option>
        </optgroup>
      </select>

      <label style="display:flex;align-items:center;gap:6px"><input id="demoToggle" type="checkbox" checked/> DEMO</label>

      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button id="connectBtn">Start</button>
        <button id="stopBtn" disabled>Stop</button>
      </div>
    </div>

    <div id="chartContainer"></div>

    <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
      <button id="simBuy">Sim BUY</button>
      <button id="simSell">Sim SELL</button>
      <button id="clearMarkers">Clear Markers</button>
      <div style="margin-left:auto" class="small">Markers persist locally for backtesting</div>
    </div>
  </div>

  <!-- RIGHT: Signals & Auto -->
  <div class="card" style="overflow:auto;padding:12px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h3 style="margin:0 0 6px 0">Lumina â€” Signals & Auto</h3>
        <div class="small">Lumina â€” Forex Partner. Auto trade enqueues to your Render bridge. Replace placeholder with your Render URL to enable live execution.</div>
      </div>
      <div>
        <span class="badge">Hybrid UI</span>
      </div>
    </div>

    <div style="margin-top:12px">
      <strong>Live Signals</strong>
      <div id="signalsList" class="signalsList"></div>
    </div>

    <hr/>

    <div style="display:flex;flex-direction:column;gap:8px">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <label style="display:flex;align-items:center;gap:6px"><input id="autoToggle" type="checkbox" /> Auto Trade</label>
        <label style="display:flex;align-items:center;gap:6px">Conf â‰¥ <input id="autoConf" type="number" min="50" max="100" value="95" style="width:72px" />%</label>
        <label style="display:flex;align-items:center;gap:6px">Risk% <input id="riskPerTrade" type="number" min="0.05" step="0.05" value="0.5" style="width:72px" />%</label>
      </div>

      <div style="display:flex;gap:8px">
        <button id="autoStartBtn">Start Auto</button>
        <button id="autoStopBtn" disabled>Stop Auto</button>
        <button id="killBtn" style="background:#9b2d2d;color:white">KILL</button>
      </div>

      <div id="autoState" class="small">Auto: OFF â€¢ Kill: OFF</div>
    </div>

    <hr/>
    <div style="margin-top:8px">
      <strong>Bridge</strong>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <input id="bridgeUrl" placeholder="https://placeholder.render.com" style="width:100%" />
        <button id="getToken">Get Token</button>
      </div>
      <div class="small" id="acctInfo" style="margin-top:8px">Account: â€”</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="sendLatest">Send Latest</button>
        <button id="sendAll">Send Last 5</button>
      </div>
    </div>

    <div class="small" style="margin-top:10px">Theme: <button id="themeToggle">Light/Dark</button> â€¢ Desktop: <button id="desktopToggleButton" class="small">Toggle</button></div>
  </div>
</div>

<!-- Assistant + controls -->
<button id="assistantToggle" class="assistantBtn" title="Open Lumina Assistant">ðŸ’œ Lumina</button>
<button id="desktopToggle" class="desktopToggle">Desktop Mode</button>
<div id="toast" class="toast"></div>

<!-- Assistant Panel -->
<div id="assistantPanel" class="assistantPanel" aria-hidden="true">
  <div class="assistantHeader">
    <div class="avatar" id="luminaAvatar" title="Lumina â€” Forex Partner">
      <!-- simple avatar -->
      <svg width="44" height="44" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="0" y="0" width="24" height="24" rx="6" fill="#fff1f8"/><path d="M12 12c1.6569 0 3-1.3431 3-3s-1.3431-3-3-3-3 1.3431-3 3 1.3431 3 3 3z" fill="#7b2aa6"/><path d="M6 20c0-2.5 3.134-4 6-4s6 1.5 6 4v0H6z" fill="#7b2aa6"/></svg>
    </div>
    <div>
      <div style="font-weight:800">Lumina â€” Forex Partner</div>
      <div class="small">Ask Lumina about chart, trades, or upload screenshot</div>
    </div>
    <div style="margin-left:auto;display:flex;gap:8px">
      <button id="assistantClose" style="background:transparent;border:none;color:var(--muted)">Close</button>
      <button id="themeToggleHeader" style="background:transparent;border:none;color:var(--muted)">Light/Dark</button>
    </div>
  </div>

  <div class="assistantBody">
    <div id="chatArea" class="chatArea"></div>

    <div class="chatInput">
      <input id="chatInput" placeholder="Ask Lumina..." style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit" />
      <button id="micBtn" class="micBtn">ðŸŽ¤</button>
      <input id="imageInput" type="file" accept="image/*" style="display:none" />
      <button id="cameraBtn" class="micBtn">ðŸ“·</button>
      <button id="sendChatBtn" class="micBtn">Send</button>
    </div>
  </div>
</div>

<script>
/* ========= CONFIG =========
 Replace BRIDGE_HTTP placeholder with your real Render bridge URL AFTER you deploy backend.
 Example: https://lumina-bridge-yourname.onrender.com
================================= */
let BRIDGE_HTTP = "https://placeholder.render.com"; // <-- REPLACE this when your Render bridge is live
let TOKEN = ""; // obtained from /token
let AUTO_ON = false;
let KILL = false;
const REQUIRE_EXACT_100_FOR_AUTO = true; // frontend guard (bridge must also enforce)

/* ---------- UI refs ---------- */
const symbolSelect = document.getElementById('symbolSelect');
const tfSelect = document.getElementById('tfSelect');
const demoToggle = document.getElementById('demoToggle');
const connectBtn = document.getElementById('connectBtn');
const stopBtn = document.getElementById('stopBtn');
const chartContainer = document.getElementById('chartContainer');
const signalsList = document.getElementById('signalsList');
const simBuy = document.getElementById('simBuy'), simSell = document.getElementById('simSell'), clearMarkersBtn = document.getElementById('clearMarkers');

const autoStartBtn = document.getElementById('autoStartBtn');
const autoStopBtn = document.getElementById('autoStopBtn');
const killBtn = document.getElementById('killBtn');
const autoStateEl = document.getElementById('autoState');
const autoConf = document.getElementById('autoConf');
const riskPerTrade = document.getElementById('riskPerTrade');

const bridgeUrlInput = document.getElementById('bridgeUrl');
const getTokenBtn = document.getElementById('getToken');
const acctInfo = document.getElementById('acctInfo');
const sendLatestBtn = document.getElementById('sendLatest');
const sendAllBtn = document.getElementById('sendAll');

const assistantToggle = document.getElementById('assistantToggle');
const assistantPanel = document.getElementById('assistantPanel');
const assistantClose = document.getElementById('assistantClose');
const chatArea = document.getElementById('chatArea');
const chatInput = document.getElementById('chatInput');
const sendChatBtn = document.getElementById('sendChatBtn');
const cameraBtn = document.getElementById('cameraBtn');
const imageInput = document.getElementById('imageInput');
const micBtn = document.getElementById('micBtn');

const themeToggle = document.getElementById('themeToggle');
const desktopToggleBtn = document.getElementById('desktopToggle');
const desktopToggleSmall = document.getElementById('desktopToggleButton');

const toast = document.getElementById('toast');
function showToast(msg){ toast.innerText = msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none',2500); }

/* ---------- Chart setup (candles: green up, red down) ---------- */
const chart = LightweightCharts.createChart(chartContainer, {
  layout: { backgroundColor: '#071022', textColor: '#e6eef8' },
  grid: { vertLines:{visible:false}, horzLines:{color:'rgba(255,255,255,0.03)'} },
  rightPriceScale: { borderVisible:false },
  timeScale: { timeVisible:true }
});
const candleSeries = chart.addCandlestickSeries({
  upColor: '#00b050', downColor: '#ff4d4d', borderVisible: true,
  wickUpColor: '#00b050', wickDownColor: '#ff4d4d', borderColor: undefined
});

/* ---------- State ---------- */
let candles = [];
let markers = [];
let latestSignal = null;
let simTimer = null;

/* ---------- 100+ Forex pairs (expandable) ---------- */
const SYMBOLS = [
  "EUR/USD","USD/JPY","GBP/USD","USD/CHF","AUD/USD","USD/CAD","NZD/USD","EUR/GBP","EUR/JPY","GBP/JPY",
  "AUD/JPY","CHF/JPY","CAD/JPY","EUR/CHF","EUR/AUD","EUR/CAD","GBP/CHF","GBP/AUD","AUD/CAD","AUD/CHF",
  "NZD/JPY","NZD/CAD","USD/ARS","USD/BRL","USD/INR","USD/MXN","USD/TRY","USD/ZAR","USD/SGD","USD/HKD",
  "EUR/TRY","GBP/TRY","TRY/JPY","EUR/NZD","GBP/NZD","CAD/CHF","CAD/SGD","AUD/NZD","EUR/SGD","GBP/SGD",
  "XAU/USD","XAG/USD","BTC/USD","ETH/USD","USD/PLN","EUR/PLN","USD/NOK","EUR/NOK","USD/SEK","EUR/SEK",
  "EUR/HUF","USD/HUF","CZK/PLN","SGD/JPY","CAD/JPY","HKD/JPY","USD/ILS","EUR/ILS","USD/KRW","USD/IDR",
  "USD/THB","EUR/DKK","USD/DKK","EUR/BGN","USD/CZK","EUR/CZK","ZAR/JPY","TRY/GBP","TRY/EUR","CHF/HKD",
  "USD/CLP","USD/COP","USD/EGP","MXN/JPY","AUD/SGD","GBP/CAD","EUR/IDR","EUR/INR","GBP/INR","AUD/INR",
  "NZD/INR","CAD/INR","EUR/MXN","GBP/MXN","AUD/CHF","BTC/EUR","ETH/EUR","USOIL","UKOIL","XPD/USD",
  "XPT/USD","EUR/USDT","USD/USDT","USDT/TRY","EUR/USDC","USD/USDC","AUD/USDT","GBP/USDT","BTC/USDT","ETH/USDT",
  "EUR/KRW","USD/KWD","USD/OMR","USD/SAR","USD/AED","EUR/BRL","GBP/BRL","BRL/USD","ARS/USD","CLP/USD"
];
SYMBOLS.forEach(s => { const o=document.createElement('option'); o.value=s; o.innerText=s; symbolSelect.appendChild(o); });
symbolSelect.value = "EUR/USD";

/* ---------- Helper: timeframe -> ms ---------- */
function tfToMs(tf){
  if(tf==='1s') return 1000; if(tf==='5s') return 5000; if(tf==='10s') return 10000; if(tf==='15s') return 15000; if(tf==='30s') return 30000;
  if(tf==='1min') return 60*1000; if(tf==='3min') return 3*60*1000; if(tf==='5min') return 5*60*1000; if(tf==='10min') return 10*60*1000;
  if(tf==='15min') return 15*60*1000; if(tf==='30min') return 30*60*1000; if(tf==='45min') return 45*60*1000;
  if(tf==='1h') return 60*60*1000; if(tf==='2h') return 2*60*60*1000; if(tf==='3h') return 3*60*60*1000; if(tf==='4h') return 4*60*60*1000;
  if(tf==='6h') return 6*60*60*1000; if(tf==='8h') return 8*60*60*1000; if(tf==='12h') return 12*60*60*1000;
  if(tf==='1day') return 24*60*60*1000; if(tf==='2day') return 2*24*60*60*1000; if(tf==='3day') return 3*24*60*60*1000;
  if(tf==='1w') return 7*24*60*60*1000; if(tf==='2w') return 14*24*60*60*1000;
  if(tf==='1M') return 30*24*60*60*1000; if(tf==='3M') return 90*24*60*60*1000; if(tf==='6M') return 180*24*60*60*1000; if(tf==='1Y') return 365*24*60*60*1000;
  return 60*1000;
}

/* ---------- Seed price (exchange-rate API fallback) ---------- */
async function seedPrice(pair){
  const [base,quote] = pair.split('/');
  try {
    const res = await fetch(`https://api.exchangerate.host/latest?base=${base}&symbols=${quote}`);
    const j = await res.json();
    if(j && j.rates && j.rates[quote]) return Number(j.rates[quote]);
  } catch(e){}
  // fallback random
  return (1 + Math.random()*0.2);
}

/* ---------- Local storage helpers for markers ---------- */
function persistMarkers(sym,tf){ try{ localStorage.setItem('lumina_markers_'+sym.replace('/','')+'_'+tf, JSON.stringify(markers)); }catch(e){} }
function loadMarkers(sym,tf){ try{ const v = localStorage.getItem('lumina_markers_'+sym.replace('/','')+'_'+tf); return v ? JSON.parse(v) : []; }catch(e){return []; } }

/* ---------- Demo candles simulator (for mobile testing) ---------- */
async function startDemo(sym,tf){
  stopDemo();
  showToast('Starting demo candles...');
  let p = await seedPrice(sym);
  candles = [];
  const now = Date.now(); const interval = tfToMs(tf);
  // initialize 60 candles
  for(let i=60;i>0;i--){
    const t = new Date(now - i*interval).toISOString();
    const o = Number((p + (Math.random()-0.5)*0.002).toFixed(6));
    const c = Number((o + (Math.random()-0.5)*0.002).toFixed(6));
    const h = Number((Math.max(o,c) + Math.random()*0.001).toFixed(6));
    const l = Number((Math.min(o,c) - Math.random()*0.001).toFixed(6));
    candles.push({ time: t, open:o, high:h, low:l, close:c });
    p = c;
  }
  candleSeries.setData(candles);
  markers = loadMarkers(sym,tf) || [];
  candleSeries.setMarkers(markers);
  simTimer = setInterval(()=> {
    const last = candles[candles.length-1];
    if(!last) return;
    // update last candle
    const newP = Number((last.close + (Math.random()-0.5)*0.0015).toFixed(6));
    last.high = Math.max(last.high, newP);
    last.low = Math.min(last.low, newP);
    last.close = newP;
    candleSeries.update(last);
    if(Math.random()<0.12){
      const o = last.close; const c = Number((o + (Math.random()-0.5)*0.003).toFixed(6)); const h = Math.max(o,c)+Math.random()*0.001; const l = Math.min(o,c)-Math.random()*0.001;
      const nc = { time: new Date().toISOString(), open:o, high:Number(h.toFixed(6)), low:Number(l.toFixed(6)), close:Number(c.toFixed(6)) };
      candles.push(nc); if(candles.length>800) candles.shift();
      candleSeries.update(nc);
    }
  }, Math.max(350, tfToMs(tf)/6));
}
function stopDemo(){ if(simTimer) clearInterval(simTimer); simTimer=null; showToast('Demo stopped'); }

/* ---------- Markers & panel ---------- */
function addMarkerAndPanel(s){
  latestSignal = s;
  const marker = { time: s.time || (candles[candles.length-1] && candles[candles.length-1].time) || new Date().toISOString(), position: s.type==='BUY'?'belowBar':'aboveBar', color: s.type==='BUY'?'#00b050':'#ff4d4d', shape: s.type==='BUY'?'arrowUp':'arrowDown', text: `${s.type} ${Math.round(s.confidence||0)}%` };
  markers.push(marker); candleSeries.setMarkers(markers); persistMarkers(s.symbol, s.timeframe);
  const el = document.createElement('div'); el.className='signalItem';
  el.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong style="color:${s.type==='BUY'?'#00b050':'#ff4d4d'}">${s.type}</strong> ${s.symbol}</div><div class="small">${new Date(s.time).toLocaleString()}</div></div>
    <div class="small" style="margin-top:6px">${s.reason||''}</div>
    <div style="margin-top:6px;font-size:13px;color:var(--muted)">Price: ${s.price} â€¢ SL: ${s.suggested_sl||'-'} â€¢ TP: ${s.suggested_tp||'-'}</div>
    <div style="margin-top:8px;display:flex;gap:8px"><button class="copyBtn">Copy</button><button class="sendBtn">Send</button></div>`;
  el.querySelector('.copyBtn').addEventListener('click', ()=> { navigator.clipboard.writeText(`${s.type} ${s.symbol} @ ${s.price} SL:${s.suggested_sl||''} TP:${s.suggested_tp||''}`); showToast('Copied'); });
  el.querySelector('.sendBtn').addEventListener('click', ()=> sendSignalToBridge(s));
  signalsList.prepend(el);
}

/* ---------- Create demo signal ---------- */
function makeSignal(type){
  const last = candles[candles.length-1];
  if(!last) return null;
  const price = last.close;
  const conf = (Math.random()>0.6) ? 100 : (95 + Math.floor(Math.random()*6));
  const s = { symbol: symbolSelect.value, timeframe: tfSelect.value, type: type, price: Number(price), confidence: conf, suggested_sl: type==='BUY'?Number((price*0.997).toFixed(6)):Number((price*1.003).toFixed(6)), suggested_tp: type==='BUY'?Number((price*1.004).toFixed(6)):Number((price*0.996).toFixed(6)), suggested_lot:0.01, time: new Date().toISOString(), reason: 'Lumina demo composite signal' };
  addMarkerAndPanel(s);
  if(document.getElementById('autoToggle').checked) window.lumina_onNewSignal && window.lumina_onNewSignal(s);
  return s;
}

/* ---------- Send signal to bridge (simple) ---------- */
async function sendSignalToBridge(signal){
  const url = (BRIDGE_HTTP && BRIDGE_HTTP!=="https://placeholder.render.com") ? BRIDGE_HTTP : bridgeUrlInput.value.trim() || BRIDGE_HTTP;
  if(!url){ showToast('Set bridge URL'); return false; }
  try {
    const res = await fetch(url.replace(/\/$/,'') + '/signal', { method:'POST', headers:{ 'Content-Type':'application/json', 'x-lumina-token': TOKEN||'' }, body: JSON.stringify(signal) });
    if(res.ok){ showToast('Signal sent'); return true; } else { showToast('Bridge error'); return false; }
  } catch(e){ console.warn(e); showToast('Send failed'); return false; }
}

/* ---------- Compute lot via bridge (optional; bridge provides a compute endpoint) ---------- */
async function computeLotBridge(symbol, price, sl, risk_pct){
  const url = (BRIDGE_HTTP && BRIDGE_HTTP!=="https://placeholder.render.com") ? BRIDGE_HTTP : bridgeUrlInput.value.trim() || BRIDGE_HTTP;
  if(!url) return null;
  try {
    const r = await fetch(url.replace(/\/$/,'') + '/compute_lot', { method:'POST', headers:{ 'Content-Type':'application/json', 'x-lumina-token': TOKEN||'' }, body: JSON.stringify({ symbol: symbol.replace('/',''), price, sl, risk_pct }) });
    if(r.ok) return await r.json();
  } catch(e){ console.warn('compute lot err', e); }
  return null;
}

/* ---------- Auto-trade frontend guard & main flow ---------- */
autoStartBtn.addEventListener('click', async ()=>{
  if(KILL){ showToast('Kill switch ON â€” disable first'); return; }
  AUTO_ON = true; autoStartBtn.disabled=true; autoStopBtn.disabled=false; updateAutoState();
  try {
    const url = (BRIDGE_HTTP && BRIDGE_HTTP!=="https://placeholder.render.com") ? BRIDGE_HTTP : bridgeUrlInput.value.trim() || BRIDGE_HTTP;
    if(url) await fetch(url.replace(/\/$/,'') + '/auto-trade', { method:'POST', headers:{ 'Content-Type':'application/json','x-lumina-token':TOKEN||''}, body: JSON.stringify({ enable:true }) });
  } catch(e){}
  showToast('Auto ON (frontend)');
});
autoStopBtn.addEventListener('click', async ()=> { AUTO_ON=false; autoStartBtn.disabled=false; autoStopBtn.disabled=true; updateAutoState(); try { const url = (BRIDGE_HTTP && BRIDGE_HTTP!=="https://placeholder.render.com") ? BRIDGE_HTTP : bridgeUrlInput.value.trim() || BRIDGE_HTTP; if(url) await fetch(url.replace(/\/$/,'') + '/auto-trade', { method:'POST', headers:{ 'Content-Type':'application/json','x-lumina-token':TOKEN||''}, body: JSON.stringify({ enable:false }) }); }catch(e){} showToast('Auto OFF');});
killBtn.addEventListener('click', ()=> { KILL = !KILL; killBtn.style.background = KILL ? '#4a4a4a' : '#9b2d2d'; killBtn.innerText = KILL ? 'KILLED' : 'KILL'; updateAutoState(); showToast(KILL ? 'Kill ON':'Kill OFF'); });

function updateAutoState(){ autoStateEl.innerText = `Auto: ${AUTO_ON?'ON':'OFF'} â€¢ Kill: ${KILL?'ON':'OFF'} â€¢ Thr: ${autoConf.value}% â€¢ Risk: ${riskPerTrade.value}%`; }

/* Called when a new signal is generated (local demo or from websocket in future) */
window.lumina_onNewSignal = async function(signal){
  addMarkerAndPanel(signal);
  if(!AUTO_ON || KILL) return;
  const confThr = Number(autoConf.value || 95);
  if(REQUIRE_EXACT_100_FOR_AUTO){
    if(Number(signal.confidence) !== 100){ showToast('Auto requires 100% â€” skipped'); return; }
  } else {
    if(Number(signal.confidence) < confThr){ showToast('Conf below threshold â€” skipped'); return; }
  }
  // compute lot (ask bridge if available) then send trade execute
  const comp = await computeLotBridge(signal.symbol, signal.price, signal.suggested_sl, Number(riskPerTrade.value));
  let lot = (comp && comp.lot) ? comp.lot : signal.suggested_lot || 0.01;
  const req = { trade: { symbol: signal.symbol.replace('/',''), type: signal.type, price: signal.price, sl: signal.suggested_sl, tp: signal.suggested_tp, lot: lot, confidence: signal.confidence }, auto: true };
  const url = (BRIDGE_HTTP && BRIDGE_HTTP!=="https://placeholder.render.com") ? BRIDGE_HTTP : bridgeUrlInput.value.trim() || BRIDGE_HTTP;
  if(!url){ showToast('Bridge URL required'); return; }
  try {
    const r = await fetch(url.replace(/\/$/,'') + '/trade/execute', { method:'POST', headers:{ 'Content-Type':'application/json', 'x-lumina-token': TOKEN||'' }, body: JSON.stringify(req) });
    const j = await r.json();
    if(r.ok && j.ok) showToast('Auto enqueued: ' + (j.order_id||j.status));
    else showToast('Auto rejected: ' + (j.error||JSON.stringify(j)));
  } catch(e){ console.error(e); showToast('Auto send failed'); }
};

/* ---------- Assistant: simple demo LLM behavior, TTS, STT, image upload ---------- */
assistantToggle.addEventListener('click', ()=> { assistantPanel.style.height='92vh'; assistantPanel.setAttribute('aria-hidden','false'); });
assistantClose.addEventListener('click', ()=> { assistantPanel.style.height='0'; assistantPanel.setAttribute('aria-hidden','true'); });

function appendChatBubble(text, who){
  const el = document.createElement('div'); el.className = 'chatBubble ' + (who==='user' ? 'bubbleUser' : 'bubbleLumina'); el.innerText = text; chatArea.appendChild(el); chatArea.scrollTop = chatArea.scrollHeight;
}

async function generateLuminaReply(text){
  // Demo rule-based replies. For production, replace with a call to your LLM endpoint on bridge.
  if(/trend|direction/i.test(text)) return 'Lumina: Short-term momentum shows bias; check 1H and 4H for confirmation.';
  if(/sl|stop|stop loss/i.test(text)) return 'Lumina: Use SL just beyond recent structure; keep risk small until strategy proven.';
  if(/hello|hi|hey/i.test(text)) return 'Hi â€” I am Lumina, your Forex partner. I analyze charts and provide signals. Test on demo first.';
  if(/backtest|history/i.test(text)) return 'Lumina: I keep markers locally for visual backtesting. For full backtesting, connect backend storage.';
  return 'Lumina: Quick analysis complete. Connect your Render bridge + MT5 executor for live execution and deeper analysis.';
}

sendChatBtn.addEventListener('click', async ()=>{
  const t = chatInput.value.trim(); if(!t) return; chatInput.value=''; appendChatBubble(t,'user'); const reply = await generateLuminaReply(t); appendChatBubble(reply,'lumina');
  if('speechSynthesis' in window){ const u = new SpeechSynthesisUtterance(reply); const voices = speechSynthesis.getVoices(); for(let v of voices){ if(/female|samantha|google uk english female|microsoft|en-us/i.test(v.name)){ u.voice=v; break; } } u.rate=1; u.pitch=1; speechSynthesis.cancel(); speechSynthesis.speak(u); }
});

/* ---------- STT (voice to text) ---------- */
let recognition = null;
try {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(SR){ recognition = new SR(); recognition.lang='en-US'; recognition.onresult=(ev)=>{ chatInput.value = ev.results[0][0].transcript; }; recognition.onend=()=>{ micBtn.innerText='ðŸŽ¤'; micBtn.disabled=false; }; }
} catch(e){ recognition=null; }
micBtn.addEventListener('click', ()=> { if(!recognition){ showToast('Voice not supported'); return; } try{ recognition.start(); micBtn.innerText='âº'; micBtn.disabled=true; }catch(e){} });

/* ---------- Image upload to bridge (for analysis) ---------- */
cameraBtn.addEventListener('click', ()=> imageInput.click());
imageInput.addEventListener('change', (ev)=> {
  const f = ev.target.files && ev.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = async ()=> {
    appendChatBubble('Image uploaded â€” Lumina analyzing...', 'user');
    const url = (BRIDGE_HTTP && BRIDGE_HTTP!=="https://placeholder.render.com") ? BRIDGE_HTTP : bridgeUrlInput.value.trim() || BRIDGE_HTTP;
    if(url && url!=="https://placeholder.render.com"){
      try { await fetch(url.replace(/\/$/,'') + '/image', { method:'POST', headers:{ 'Content-Type':'application/json','x-lumina-token':TOKEN||'' }, body: JSON.stringify({ image: reader.result, meta:{ symbol: symbolSelect.value, timeframe: tfSelect.value } }) }); appendChatBubble('Lumina: Image sent to bridge for analysis.', 'lumina'); } catch(e){ appendChatBubble('Lumina: Image send failed.', 'lumina'); }
    } else { appendChatBubble('Lumina: Demo analysis â€” connect bridge for full image analysis.', 'lumina'); }
  };
  reader.readAsDataURL(f);
});

/* ---------- Bridge helpers: token, send latest ---------- */
getTokenBtn.addEventListener('click', async ()=> {
  const url = bridgeUrlInput.value.trim() || BRIDGE_HTTP;
  if(!url){ showToast('Set bridge URL'); return; }
  try { const r = await fetch(url.replace(/\/$/,'') + '/token'); const j = await r.json(); TOKEN = j.token; showToast('Got demo token'); acctInfo.innerText = 'Token OK (demo)'; } catch(e){ showToast('Token fetch failed'); }
});

sendLatestBtn.addEventListener('click', async ()=> {
  if(!latestSignal){ showToast('No latest signal'); return; }
  const url = bridgeUrlInput.value.trim() || BRIDGE_HTTP;
  if(!url){ showToast('Set bridge URL'); return; }
  try {
    const req = { trade: { symbol: latestSignal.symbol.replace('/',''), type: latestSignal.type, price: latestSignal.price, sl: latestSignal.suggested_sl, tp: latestSignal.suggested_tp, lot: latestSignal.suggested_lot, confidence: latestSignal.confidence }, auto: false };
    const r = await fetch(url.replace(/\/$/,'') + '/trade/execute', { method:'POST', headers:{ 'Content-Type':'application/json','x-lumina-token':TOKEN||'' }, body: JSON.stringify(req) });
    const j = await r.json(); if(r.ok && j.ok) showToast('Enqueued: ' + j.order_id); else showToast('Rejected: ' + (j.error||JSON.stringify(j)));
  } catch(e){ showToast('Send failed'); }
});

sendAllBtn.addEventListener('click', async ()=> { showToast('Send Last 5 not implemented (demo)'); });

/* ---------- UI events ---------- */
connectBtn.addEventListener('click', ()=> { if(demoToggle.checked) startDemo(symbolSelect.value, tfSelect.value); else { BRIDGE_HTTP = bridgeUrlInput.value.trim() || BRIDGE_HTTP; showToast('Bridge mode active'); } connectBtn.disabled=true; stopBtn.disabled=false; });
stopBtn.addEventListener('click', ()=> { stopDemo(); connectBtn.disabled=false; stopBtn.disabled=true; });
simBuy.addEventListener('click', ()=> makeSignal('BUY'));
simSell.addEventListener('click', ()=> makeSignal('SELL'));
clearMarkersBtn.addEventListener('click', ()=> { if(confirm('Clear markers?')){ markers=[]; candleSeries.setMarkers([]); persistMarkers(symbolSelect.value, tfSelect.value); showToast('Cleared'); } });

document.getElementById('themeToggle').addEventListener('click', ()=> { document.body.classList.toggle('light'); showToast(document.body.classList.contains('light') ? 'Light mode' : 'Dark mode'); });
document.getElementById('themeToggleHeader').addEventListener('click', ()=> { document.body.classList.toggle('light'); showToast(document.body.classList.contains('light') ? 'Light mode' : 'Dark mode'); });
desktopToggleBtn.addEventListener('click', ()=> { const is = document.body.classList.toggle('desktop'); desktopToggleBtn.innerText = is ? 'Mobile Mode' : 'Desktop Mode'; showToast(is ? 'Desktop mode ON' : 'Mobile mode ON'); });
desktopToggleSmall.addEventListener('click', ()=> { const is = document.body.classList.toggle('desktop'); desktopToggleSmall.innerText = is ? 'Mobile Mode' : 'Desktop Mode'; showToast(is ? 'Desktop mode ON' : 'Mobile mode ON'); });

/* ---------- init ---------- */
(function init(){
  markers = loadMarkers(symbolSelect.value, tfSelect.value) || [];
  candleSeries.setMarkers(markers || []);
  updateAutoState();
})();
function updateAutoState(){ autoStateEl.innerText = `Auto: ${AUTO_ON?'ON':'OFF'} â€¢ Kill: ${KILL?'ON':'OFF'} â€¢ Thr: ${autoConf.value}% â€¢ Risk: ${riskPerTrade.value}%`; }

</script>
</body>
</html>

